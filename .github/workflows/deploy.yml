name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Deployment target"
        required: true
        default: dev
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy-dev:
    if: github.event_name == 'push' || github.event.inputs.target == 'dev'
    runs-on: ubuntu-latest
    env:
      DATABRICKS_PROFILE: retail-dev
      DATABRICKS_WORKSPACE_USER: ${{ secrets.DATABRICKS_WORKSPACE_USER_DEV }}
      DATABRICKS_SECRET_SCOPE: retail-secrets
      DATABRICKS_ENABLE_ML: "true"
      DATABRICKS_JOB_ID: ${{ secrets.DATABRICKS_JOB_ID_DEV }}
      SNOWFLAKE_PROFILE: retail-dev
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install CLIs
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli-labs
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          echo "$HOME/.databricks/bin" >> "$GITHUB_PATH"

      - name: Configure Databricks profile
        run: |
          {
            echo "[retail-dev]"
            echo "host = ${{ secrets.DATABRICKS_HOST_DEV }}"
            echo "token = ${{ secrets.DATABRICKS_TOKEN_DEV }}"
          } > "$HOME/.databrickscfg"

      - name: Verify Databricks auth (dev)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
        run: |
          databricks current-user me --profile retail-dev || databricks current-user me

      - name: Configure Snowflake profile
        run: |
          mkdir -p "$HOME/.snowflake"
          {
            echo "[connections.retail-dev]"
            echo "account = \"${{ secrets.SNOWFLAKE_ACCOUNT_DEV }}\""
            echo "user = \"${{ secrets.SNOWFLAKE_USER_DEV }}\""
            echo "password = \"${{ secrets.SNOWFLAKE_PASSWORD_DEV }}\""
            echo "role = \"${{ secrets.SNOWFLAKE_ROLE_DEV }}\""
            echo "warehouse = \"${{ secrets.SNOWFLAKE_WAREHOUSE_DEV }}\""
            echo "database = \"${{ secrets.SNOWFLAKE_DATABASE_DEV }}\""
            echo "schema = \"GOLD\""
          } > "$HOME/.snowflake/config.toml"
          chmod 600 "$HOME/.snowflake/config.toml"

      - name: Deploy Databricks notebooks/jobs
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
        run: |
          bash scripts/deploy_databricks_workspace.sh "$DATABRICKS_PROFILE"
          bash databricks/deploy_databricks_job.sh

      - name: Run Snowflake pipeline (dev)
        run: bash scripts/run_snowflake_pipeline.sh "$SNOWFLAKE_PROFILE"

      - name: Trigger Databricks run (dev)
        run: bash databricks/run_now.sh

  deploy-prod:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prod'
    runs-on: ubuntu-latest
    environment: prod
    env:
      DATABRICKS_PROFILE: retail-prod
      DATABRICKS_WORKSPACE_USER: ${{ secrets.DATABRICKS_WORKSPACE_USER_PROD }}
      DATABRICKS_SECRET_SCOPE: retail-secrets
      DATABRICKS_ENABLE_ML: "true"
      DATABRICKS_JOB_ID: ${{ secrets.DATABRICKS_JOB_ID_PROD }}
      SNOWFLAKE_PROFILE: retail-prod
      SNOWFLAKE_PROFILE_PROD: retail-prod
      DATABRICKS_PROFILE_PROD: retail-prod
      DATABRICKS_JOB_ID_PROD: ${{ secrets.DATABRICKS_JOB_ID_PROD }}
      RUN_ML_AFTER_SQL_PROD: "true"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install CLIs
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli-labs
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          echo "$HOME/.databricks/bin" >> "$GITHUB_PATH"

      - name: Configure Databricks profile
        run: |
          {
            echo "[retail-prod]"
            echo "host = ${{ secrets.DATABRICKS_HOST_PROD }}"
            echo "token = ${{ secrets.DATABRICKS_TOKEN_PROD }}"
          } > "$HOME/.databrickscfg"

      - name: Verify Databricks auth (prod)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_PROD }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_PROD }}
        run: |
          databricks current-user me --profile retail-prod || databricks current-user me

      - name: Configure Snowflake profile
        run: |
          mkdir -p "$HOME/.snowflake"
          {
            echo "[connections.retail-prod]"
            echo "account = \"${{ secrets.SNOWFLAKE_ACCOUNT_PROD }}\""
            echo "user = \"${{ secrets.SNOWFLAKE_USER_PROD }}\""
            echo "password = \"${{ secrets.SNOWFLAKE_PASSWORD_PROD }}\""
            echo "role = \"${{ secrets.SNOWFLAKE_ROLE_PROD }}\""
            echo "warehouse = \"${{ secrets.SNOWFLAKE_WAREHOUSE_PROD }}\""
            echo "database = \"${{ secrets.SNOWFLAKE_DATABASE_PROD }}\""
            echo "schema = \"GOLD\""
          } > "$HOME/.snowflake/config.toml"
          chmod 600 "$HOME/.snowflake/config.toml"

      - name: Deploy Databricks notebooks/jobs
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_PROD }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_PROD }}
        run: |
          bash scripts/deploy_databricks_workspace.sh "$DATABRICKS_PROFILE"
          bash databricks/deploy_databricks_job.sh

      - name: Run Snowflake + ML prod flow
        run: bash scripts/run_after_bronze_change_prod.sh
